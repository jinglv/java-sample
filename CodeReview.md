# 如何做代码审查

## 代码审查3W

### What--什么是代码审查

对计算机**源代码**系统化地审查，常用**软件同行**评审的方式进行，其**目的**是在找出及修正在软件开发初期未发现的错误，提升软件质量及开发者的技术

#### 代码审查好处

- 帮助提高代码质量
- 上下文共享
- 帮助新人快速融入项目
- 帮助开发人员成长
- 帮助影响力建设

#### 代码审查的代价

- 专门的时间和精力：选择合适的代码审查方式
- 可能引起团队成员间的不适：沟通技巧，正向反馈等i

### 什么时候进行代码审查

有**代码变更**就可以进行代码审查

- 已提交到远程仓库（merge）
- 未提交到远程仓库

#### 代码审查频率

- 集中式（团队人员集中进行，沟通效率高，每天不超过一次）
- 异步试（借助工具）



## 常见的代码审查工具

- 代码版本控制管理工具
  - git
  - svn
- 代码审查工具
  - Gerrit
  - Upsource

## 代码审查流程

### 范根检查法

### 轻量级的审查流程

- 结对编程

- 同步代码审查

- 异步代码审查

  

## 代码审查需要关注什么

### 编码风格

#### 命名风格

- 不以下划线或美元符号开头或结束
- 类名UpperCamelCase，驼峰式
- 方法名、参数名、成员变量、局部变量都统一使用lowerCamelCase风格
- 常量命名使用全大写，单词间用下划线分割
- 包名统一使用小写
- 禁止拼音命名

#### 常量定义

- 禁止未定义的常量
- 长整型赋值需要使用大写L后缀，eg.TOTAL
- 变量值可穷举，考虑使用枚举

#### 代码格式

- 采用4个空格缩进，禁止使用tab字符

- 单行字符数限制不超过120个，如果超过则使用换行

- 换行符使用unix格式

- 运算符的左右两边都需要加一个空格

- 保留字与括号之间都必须加空格

- 多个参数逗号后需要加空格

- 左大括号前不换行，左大括号后换行；

  右大括号前换行，终止的右大括号后换行

#### OOP规约

- 静态方法/变量使用类名访问（减少编译成本）

- 复写方法增加@Override

- 禁止过时的方法/类的使用

- 包装类型的比较使用equals方法
eg.
```
public static void main(String[] args){
    Integer a = 512;
    Integer b = 512;
    System.out.println(a == b); //对于包装类==是比较的地址，而不是数值，比较数值则需要equals
}
```

  

#### 分支控制

- switch中，每个case必须使用continue/break/return终止或者注释说明到哪个case终止
- switch需要对字符串判空
- 分支逻辑使用大括号

#### 注释

- 类/方法注释使用javadoc规范
- 方法内部单行注释，使用//在需要被注释的语句上方单起一行
- 无用的代码是删除，而不是注释



插件工具：IDE

- Aibaba Java Coding Guidelines
- Gradle

### 命名规范

编码有两大难题，一是起名字，二是其他问题

- 什么样的命名是可接受的
  - 足够长以揭示意图，但又不太长难以阅读
- 命名Tips
  - 使用有意义的名字
  - 范围越大，命名越长
  - 范围越小，命名越短
  - 避免使用非约定的缩写
  - 使用一种自然语言来命名。比如英语
  - 使用对应领域的专业名称，比如算法名称等
  - 不好命名，考虑类、方法职责过多，是否需要拆分重构
  - 一致性

### 功能性

- 代码是否符合**用户**意图
  - 用户
    - 真是用户（使用者）
    - 开发者
- 功能性炎症维度
  - 输入输出、流程是否正确
  - 边界是否考虑处理妥当
  - 是否有高并发的安全问题

### 测试覆盖

#### 什么是软件测试

在规定的条件下对程序进行操作，以发现程序错误，衡量软件质量，并对其是否能满足设计要求进行评估的过程

#### 自动化测试的必要性

测试时间会占到总开发时间的20%~40%，一些可靠性要求非常高的软件，测试时间甚至占到总开发时间的60%

#### 测试覆盖率

- JACOCO

### 复杂度

#### 复杂度高的问题

- 可读性降低
- 可维护性降低
- 缺陷概率高

#### 复杂度度量

- 圈复杂度
  - V(G)=判断节点数（if、for、while、case、||、&&...） + 1
  - 方法的复杂度在10以内
- 复杂度的优化
  - 方法抽取
  - 反向表达
  - 单一职责
  - 使用多态

### 注释

- 帮助理解作者意图
- 帮助正确使用

#### 好的代码无需注释？

- 代码即注释
- 代码在可读也不及自然语言

#### 注释写到何种程度？

- 对外、公共的接口
- 模块、系统描述
- 宁缺毋滥（宁可没有注释，也不要写不准确的注释）

### 设计

#### 为什么要审查设计

- 提升系统稳健性
- 提升可读性/可维护性
- 提升可扩展性

#### 设计维度需要审查什么

- 是否足够解耦
- 是否可以使用一些设计模式
- 是否可以应对一些变化
- 是否过度设计

### 安全性

#### 安全性低有什么问题

- 数据易泄露
- 程序运行异常
- 资源消耗异常

#### 安全维度需要审查什么

- 源码库是否包含凭据
- 敏感数据是否加密落库
- 输出是否安全（输出的数据是否有敏感信息：是否脱敏）

#### 安全维度需要审查什么

- 输入是否安全（数据合法性的校验）
- 权限管控是否准确
- 返回值谨慎使用null

#### 自动化工具

- sqlmp
- owasp
- WebCruiser

## 如何让代码审核更加高效

### 被审查代码作者

- 变更描述要足够清楚
- 单次改动不要过大
- 积极接收反馈

### 审查代码者

- 度量标准
- 审查速度
- 给予良好的反馈
